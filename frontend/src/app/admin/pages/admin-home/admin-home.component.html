@if (authService.isLoggedIn()) {

<div class="card">
  <p-menubar [model]="items">
      <ng-template pTemplate="start">
          <a href="/">
          <img [src]="'images/logos/' + socialIcons.logo.image.name['tr']" 
            [height]="'60'" alt="Airport Transfer Turkey" class="logo" >
          </a>
      </ng-template>
      <ng-template pTemplate="item" let-item let-root="root">
          <a pRipple class="flex align-items-center p-menuitem-link" 
              [routerLink]="item.routerLink"
              [ngClass]="{'active': item.routerLink === activeRoute}"
              >
              <span [class]="item.icon" style="margin-right:5px;"></span>
              <span class="ml-2"> {{ item.label }}</span>
              <p-badge *ngIf="item.badge" 
                  [ngClass]="{ 'ml-auto': !root, 'ml-2': root }" 
                  [value]="item.badge" />
              <span *ngIf="item.shortcut" class="ml-auto border-1 surface-border border-round surface-100 text-xs p-1">{{ item.shortcut }}</span>
              <i *ngIf="item.items" [ngClass]="['pi', root ? 'pi-angle-down ml-2' : 'pi-angle-right ml-auto']"></i>
          </a>
      </ng-template>
      <ng-template pTemplate="end">
          <div 
              style="cursor: pointer;display:flex;align-items:center;" 
              (click)="op.toggle($event)" 
              >
                  <span style="margin-right:3px;">{{userService.userDetailSignal()?.first_name| titlecase }}</span>
                  <!-- <p-avatar 
                  image="" 
                  shape="circle" 
                  class="avatar-border"
              /> -->
              <i class="pi pi-user" 
              style="font-size: 1.5rem; margin-left: 3px;">
                <!-- <img src="images/icons/user.svg" alt="user" style="width: 1.5rem; height: 1.5rem;"> -->
            </i>

          </div>
          
          <p-popover #op>
              <p-menu [model]="userMenuItems" />
          </p-popover>

      </ng-template>
  </p-menubar>
</div>

@if (showDashboard) {
  <section class="admin-dashboard">
    <div class="utility-bar">
      <form class="global-search" (ngSubmit)="onGlobalSearch()">
        <span class="p-input-icon-left">
          <i class="pi pi-search"></i>
          <input
            pInputText
            [(ngModel)]="globalSearchTerm"
            name="globalSearch"
            autocomplete="off"
            placeholder="Search reservations, passengers or emails"
          />
        </span>
        <button
          pButton
          type="submit"
          label="Search"
          icon="pi pi-arrow-right"
          [disabled]="!globalSearchTerm.trim()"
        ></button>
      </form>

      <p-tag severity="success" [value]="systemStatusMessage"></p-tag>
    </div>

    @if (dashboardError) {
      <p class="error-message">{{ dashboardError }}</p>
    }

    @if (dashboardLoading) {
      <div class="loading-state">Dashboard verileri yükleniyor…</div>
    } @else {
      @if (showKpis && kpis.length) {
        <section class="kpi-grid">
          @for (kpi of kpis; track kpi.id) {
            <p-card class="kpi-card">
              <div class="kpi-content">
                <span class="kpi-icon">
                  <i [class]="kpi.icon"></i>
                </span>
                <div class="kpi-text">
                  <span class="kpi-label">{{ kpi.label }}</span>
                  <span class="kpi-value">{{ kpi.value }}</span>
                  @if (kpi.helper) {
                    <span class="kpi-helper">{{ kpi.helper }}</span>
                  }
                </div>
              </div>
            </p-card>
          }
        </section>
      }

      <section class="urgent-queues">
        @if (pendingSettlementIntents.length) {
        <div class="urgent-column">
          <div class="section-heading">
            <h3>Onaylanmayı Bekleyen Ödemeler</h3>
            <div class="section-controls">
              <p-select
                [options]="pendingSettlementPaymentOptions"
                [(ngModel)]="pendingSettlementPaymentFilter"
                optionLabel="label"
                optionValue="value"
                placeholder="Ödeme yöntemi"
                [showClear]="false"
              ></p-select>
              <a
                class="section-action"
                [routerLink]="['/admin/payments/intents']"
                [queryParams]="pendingSettlementQueryParams"
              >
                See all
              </a>
            </div>
          </div>
          <table class="plain-table">
            <tbody>
              @for (intent of filteredPendingSettlementIntents; track intent.public_id) {
                <tr
                  (click)="openPendingIntent(intent, $event)"
                  [class.row-loading]="isCardLoading('pending-intent', intent.public_id || intent.booking_ref || intent.reservation?.id)"
                  [attr.aria-busy]="isCardLoading('pending-intent', intent.public_id || intent.booking_ref || intent.reservation?.id)"
                >
                  <td class="primary">
                    <div class="item-title">
                      {{ intent.reservation?.passenger_name || intent.customer_name || intent.booking_ref }}
                    </div>
                    <div class="item-subtitle">
                      {{ intent.booking_ref }}
                      @if (intent.reservation?.transfer_date || intent.reservation?.transfer_time) {
                        &nbsp;&#8226;&nbsp;
                        {{ intent.reservation?.transfer_date || '' }}
                        {{ intent.reservation?.transfer_time || '' }}
                      }
                    </div>
                    @if (intent.reservation?.pickup_short || intent.reservation?.dest_short) {
                      <div class="item-subtitle">
                        {{ intent.reservation?.pickup_short || 'Pickup TBD' }}
                        →
                        {{ intent.reservation?.dest_short || 'Dropoff TBD' }}
                      </div>
                    }
                  </td>
                  <td class="secondary">
                    <div class="item-created">
                      {{ formatCurrency(intent.amount_minor, intent.currency) }}
                    </div>
                    @if (intent.due_minor > 0) {
                      <div class="item-subtitle">
                        Due {{ formatCurrency(intent.due_minor, intent.currency) }}
                      </div>
                    }
                  </td>
                  <td class="actions">
                    <span
                      class="row-spinner"
                      *ngIf="isCardLoading('pending-intent', intent.public_id || intent.booking_ref || intent.reservation?.id)"
                      aria-hidden="true"
                    ></span>
                    <i
                      class="pi pi-arrow-right"
                      *ngIf="!isCardLoading('pending-intent', intent.public_id || intent.booking_ref || intent.reservation?.id)"
                    ></i>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
        }

        @if (pendingConfirmationReservations.length) {
        <div class="urgent-column">
          <div class="section-heading">
            <h3>Pending Confirmation</h3>
            <a
              class="section-action"
              [routerLink]="['/admin/reservations']"
              [queryParams]="pendingConfirmationQueryParams"
            >
              See all
            </a>
          </div>
          <table class="plain-table">
            <tbody>
              @for (reservation of pendingConfirmationReservations; track reservation.id) {
                <tr
                  (click)="openReservation(reservation, $event)"
                  [class.row-loading]="isCardLoading('reservation', reservation.id || reservation.number || reservation.passenger_email)"
                  [attr.aria-busy]="isCardLoading('reservation', reservation.id || reservation.number || reservation.passenger_email)"
                >
                  <td class="primary">
                    <div class="item-title">
                      {{ reservation.number || reservation.passenger_name || ('Reservation #' + reservation.id) }}
                    </div>
                    <div class="item-subtitle">
                      {{ reservation.passenger_name || reservation.passenger_email || 'Guest' }}
                      @if (reservation.status) {
                        &nbsp;&#8226;&nbsp;{{ reservation.status | titlecase }}
                      }
                      @if (reservation.transfer_date || reservation.transfer_time) {
                        &nbsp;&#8226;&nbsp;{{ reservation.transfer_date || '' }} {{ reservation.transfer_time || '' }}
                      }
                    </div>
                  </td>
                  <td class="secondary">
                    <span class="item-created">
                      {{ reservation.created_at | date: 'MMM d, HH:mm' }}
                    </span>
                  </td>
                  <td class="actions">
                    <span
                      class="row-spinner"
                      *ngIf="isCardLoading('reservation', reservation.id || reservation.number || reservation.passenger_email)"
                      aria-hidden="true"
                    ></span>
                    <i
                      class="pi pi-arrow-right"
                      *ngIf="!isCardLoading('reservation', reservation.id || reservation.number || reservation.passenger_email)"
                    ></i>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
        }

        @if (urgentChangeRequests.length) {
        <div class="urgent-column">
          <div class="section-heading">
            <h3>Change Requests</h3>
            <a
              class="section-action"
              [routerLink]="['/admin/reservations']"
              [queryParams]="changeRequestQueryParams"
            >
              See all
            </a>
          </div>
          <table class="plain-table">
            <tbody>
              @for (changeRequest of urgentChangeRequests; track changeRequest.id) {
                <tr
                  (click)="openChangeRequest(changeRequest, $event)"
                  [class.row-loading]="isCardLoading('change-request', changeRequest.id)"
                  [attr.aria-busy]="isCardLoading('change-request', changeRequest.id)"
                >
                  <td class="primary">
                    <div class="item-title">
                      {{ changeRequest.reservation_number || ('Request #' + changeRequest.id) }}
                    </div>
                    <div class="item-subtitle">
                      {{ changeRequest.status | titlecase }}
                    </div>
                  </td>
                  <td class="secondary">
                    <span class="item-created">
                      {{ changeRequest.created_at | date: 'MMM d, HH:mm' }}
                    </span>
                  </td>
                  <td class="actions">
                    <span class="row-spinner" *ngIf="isCardLoading('change-request', changeRequest.id)" aria-hidden="true"></span>
                    <i class="pi pi-arrow-right" *ngIf="!isCardLoading('change-request', changeRequest.id)"></i>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
        }

        @if (urgentReviews.length) {
        <div class="urgent-column">
          <div class="section-heading">
            <h3>Urgent Reviews</h3>
            <a
              class="section-action"
              [routerLink]="['/admin/reviews']"
              [queryParams]="urgentReviewQueryParams"
            >
              See all
            </a>
          </div>
          <table class="plain-table">
            <tbody>
              @for (review of urgentReviews; track review.id) {
                <tr
                  (click)="openReview(review, $event)"
                  [class.row-loading]="isCardLoading('review', review.id)"
                  [attr.aria-busy]="isCardLoading('review', review.id)"
                >
                  <td class="primary">
                    <div class="item-title">{{ review.title || ('Review #' + review.id) }}</div>
                    <div class="item-subtitle">
                      Rating: {{ review.rating }}/5
                      @if (review.status) {
                        &nbsp;&#8226;&nbsp;Status: {{ review.status | titlecase }}
                      }
                      @if (review.is_flagged) {
                        &nbsp;&#8226;&nbsp;Flagged
                      }
                    </div>
                  </td>
                  <td class="secondary">
                    <span class="item-created">
                      {{ review.updated_at | date: 'MMM d, HH:mm' }}
                    </span>
                  </td>
                  <td class="actions">
                    <span class="row-spinner" *ngIf="isCardLoading('review', review.id)" aria-hidden="true"></span>
                    <i class="pi pi-arrow-right" *ngIf="!isCardLoading('review', review.id)"></i>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
        }

        @if (upcomingTransfers.length) {
        <div class="urgent-column">
          <div class="section-heading">
            <h3>Upcoming Transfers (24h)</h3>
            <a
              class="section-action"
              [routerLink]="['/admin/reservations']"
              [queryParams]="upcomingTransferQueryParams"
            >
              See all
            </a>
          </div>
          <table class="plain-table">
            <tbody>
              @for (transfer of upcomingTransfers; track transfer.id) {
                <tr
                  (click)="openReservation(transfer, $event)"
                  [class.row-loading]="isCardLoading('reservation', transfer.id || transfer.number || transfer.passenger_email)"
                  [attr.aria-busy]="isCardLoading('reservation', transfer.id || transfer.number || transfer.passenger_email)"
                >
                  <td class="primary">
                    <div class="item-title">{{ transfer.passenger_name || transfer.passenger_email || 'Unknown passenger' }}</div>
                    <div class="item-subtitle">
                      {{ transfer.transfer_date || '—' }} {{ transfer.transfer_time || '' }}
                    </div>
                  </td>
                  <td class="secondary">
                    <span class="route">
                      {{ transfer.pickup_short || 'Pickup TBD' }} → {{ transfer.dest_short || 'Dropoff TBD' }}
                    </span>
                  </td>
                  <td class="actions">
                    <span
                      class="row-spinner"
                      *ngIf="isCardLoading('reservation', transfer.id || transfer.number || transfer.passenger_email)"
                      aria-hidden="true"
                    ></span>
                    <i
                      class="pi pi-arrow-right"
                      *ngIf="!isCardLoading('reservation', transfer.id || transfer.number || transfer.passenger_email)"
                    ></i>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
        }
      </section>
      @if (activityFeed.length) {
      <section class="activity-feed">
        <div class="section-heading">
          <h3>Recent Activity</h3>
        </div>
          <ul class="activity-list">
            @for (activity of activityFeed; track activity.id) {
              <li
                (click)="openActivityItem(activity, $event)"
                role="button"
                tabindex="0"
                (keydown.enter)="openActivityItem(activity, $event)"
                (keydown.space)="openActivityItem(activity, $event)"
                [class.row-loading]="isCardLoading('activity', activity.id)"
                [attr.aria-busy]="isCardLoading('activity', activity.id)"
              >
                <span class="activity-icon">
                  <i [class]="activity.icon"></i>
                </span>
                <div class="activity-details">
                  <div class="activity-title">{{ activity.title }}</div>
                  <div class="activity-meta">
                    <span>{{ activity.subtitle }}</span>
                    <span class="bullet">•</span>
                    <span>{{ activity.relativeTime }}</span>
                  </div>
                </div>
                <span class="row-spinner" *ngIf="isCardLoading('activity', activity.id)" aria-hidden="true"></span>
                <i class="pi pi-arrow-right activity-action" *ngIf="!isCardLoading('activity', activity.id)"></i>
              </li>
            }
          </ul>
      </section>
      }
    }
  </section>
}
} @else {
  <app-auth-login></app-auth-login>
}

<router-outlet></router-outlet>
