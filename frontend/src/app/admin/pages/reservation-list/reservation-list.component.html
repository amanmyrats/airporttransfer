<app-filter-search [statuses]="statuses" [changeRequestStatuses]="changeRequestStatuses" [wantDateFilter]="true"
    [wantDetailedButton]="true"
    [detailedFilterKeys]="detailedFilterKeys"
    [wantStatusFilter]="true" [wantChangeRequestStatusFilter]="true" [wantSearchFilter]="true"
    [wantDateVariationFilter]="true" [wantDateRangeFilter]="true"
    [wantReservationCreationDateVariationFilter]="true" [wantReservationCreationDateRangeFilter]="true"
    [first]="first" [rows]="rows"
    (searchEmitter)="search($event)" (getStatusesEmitter)="getStatuses()"
    (getChangeRequestStatusesEmitter)="getChangeRequestStatuses()">
</app-filter-search>
<app-shared-toolbar [wantExport]="true" [isExporting]="isExporting" (exportEmitter)="export()"
    (searchEmitter)="search()">
</app-shared-toolbar>

<p-table [columns]="selectedColumns" [value]="reservations" styleClass="p-datatable-gridlines" [rowHover]="true"
    [loading]="loading" [resizableColumns]="true" columnResizeMode="expand" [reorderableColumns]="true"
    (onColResize)="onColResize($event)" (onColReorder)="onColReorder($event)" [tableStyle]="{'min-width': '70rem'}">
    <ng-template pTemplate="caption">
        <div class="table-caption">
            <div class="caption__title">REZERVASYONLAR</div>
            <p-multiSelect class="caption__selector" [options]="cols" [(ngModel)]="selectedColumns" optionLabel="header"
                (onChange)="onColumnSelect($event)" selectedItemsLabel="{0} kolon seçildi"
                placeholder="Kolon seçiniz" />
        </div>
    </ng-template>

    <ng-template pTemplate="header" let-columns>
        <tr>
            <th style="width: 50px; text-align: center;">
                #
            </th>
            <th *ngFor="let col of columns" pResizableColumn pReorderableColumn [style.width.px]="col.width"
                style="white-space: normal; word-break: normal; overflow-wrap: break-word;">
                {{col.header}}
            </th>
            <th></th>
        </tr>
    </ng-template>
    <ng-template pTemplate="body" let-reservation let-columns="columns" let-rowIndex="rowIndex">
        <tr *ngIf="loading">
            <td><p-skeleton /></td>
            <td><p-skeleton /></td>
            <td><p-skeleton /></td>
            <td><p-skeleton /></td>
        </tr>
        <tr class="{{reservation.status}}">


            <!-- Order Number Column -->
            <td style="width: 50px; text-align: center;">
                @if (filterSearch.event.first) {
                    {{ filterSearch.event.first + rowIndex + 1 }}
                } @else {
                    {{ rowIndex + 1 }}
                }
            </td>

            <td *ngFor="let col of columns" [style.minWidth.px]="col.min_width" [style.maxWidth.px]="col.width"
                [style.width.px]="col.width">
                <div [style.width.px]="col.width * 0.80"
                    style="white-space: normal; word-break: normal; overflow-wrap: break-word;">


                    @if (col.field === 'number') {
                        {{reservation.number}}
                        <br>
                        {{reservation.reservation_date}}
                        <br>
                        <br>
                        {{reservation.direction_type}}
                        <br>
                        {{reservation.car_type}}

                        <br>
                        <br>
                        <p-button [label]="getStatusLabel(reservation.status)"
                            [severity]="getStatusSeverity(reservation.status)" class="status-btn" [rounded]="true"
                            size="small" (click)="openStatusForm(reservation)">
                            <ng-template pTemplate="icon">
                                <fa-icon [icon]="faPencil"></fa-icon>
                            </ng-template>
                        </p-button>
                        <br>
                        <button
                            *ngIf="reservation.latest_change_request_status"
                            pButton
                            type="button"
                            class="cr-status-button"
                            [label]="getChangeRequestStatusLabel(reservation.latest_change_request_status)"
                            [severity]="getChangeRequestStatusSeverity(reservation.latest_change_request_status)"
                            [rounded]="true"
                            size="small"
                            (click)="openChangeRequests(reservation)"
                            title="Değişiklik isteğini görüntüle"
                        ></button>
                    }

                    @if (col.field === 'transfer_date') {
                    {{reservation.transfer_date}}
                    <br>
                    <br>
                    {{reservation.transfer_time}}
                    <br>
                    <br>
                    @if (reservation.flight_number) {
                        <fa-icon [icon]="getDirectionPlaneIcon(reservation.direction_type)" size="lg"
                            style="margin-left: 5px;"></fa-icon>
                        {{reservation.flight_number}}
                    }

                    }

                    @if (col.field === 'pickup_full') {
                    @if (reservation.pickup_short) {
                    <span class="location-short">{{reservation.pickup_short}}</span>
                    <br>
                    }
                    {{reservation.pickup_full}}
                    <br>
                    <fa-icon [icon]="faArrowsUpDown" size="lg" style="display: inline-block; margin: 10px 0;"></fa-icon>
                    <br>
                    @if (reservation.dest_short) {
                    <span class="location-short">{{reservation.dest_short}}</span>
                    <br>
                    }
                    {{reservation.dest_full}}
                    <div class="route-meta"
                        *ngIf="formatDistance(reservation.distance) || formatDuration(reservation.driving_duration)">
                        <span *ngIf="formatDistance(reservation.distance)">
                            {{ formatDistance(reservation.distance) }}
                        </span>
                        <span *ngIf="formatDistance(reservation.distance) && formatDuration(reservation.driving_duration)">
                            •
                        </span>
                        <span *ngIf="formatDuration(reservation.driving_duration)">
                            {{ formatDuration(reservation.driving_duration) }}
                        </span>
                    </div>
                    }

                    <div *ngIf="col.field === 'amount'" [style.width.px]="col.width * 0.80"
                        style="white-space: normal; word-break: normal; overflow-wrap: break-word;">
                        <!-- <fa-icon *ngIf="reservation.is_nakit == '1'" [icon]="faSackDollar" size="2x"></fa-icon>
                            <fa-icon *ngIf="reservation.is_nakit == '0'" [icon]="faCreditCard" size="2x"></fa-icon>
                            <fa-icon *ngIf="reservation.is_nakit == 'null'" [icon]="faCircleQuestion" size="2x"></fa-icon>

                        {{reservation.amount | number:'1.2-2' }}
                        {{currencyService.getCurrencySign(reservation.currency_code)}} -->

                    <span class="reservation-amount-container">
                        <span class="reservation-payment-icon">
                            <fa-icon *ngIf="reservation.is_nakit == '1'" [icon]="faSackDollar" size="lg"></fa-icon>
                            <fa-icon *ngIf="reservation.is_nakit == '0'" [icon]="faCreditCard" size="lg"></fa-icon>
                            <fa-icon *ngIf="reservation.is_nakit == 'null'" [icon]="faCircleQuestion" size="lg"></fa-icon>
                        </span>
                    
                        <span class="reservation-amount-details">
                            <span class="reservation-amount">
                                {{reservation.amount | number:'1.2-2' }} {{currencyService.getCurrencySign(reservation.currency_code)}}
                            </span>
                            <div *ngIf="reservation.payment_status" class="payment-status">
                                <!-- <span class="payment-status__label">Payment:</span> -->
                                <span class="payment-status__badge"
                                    [ngClass]="paymentStatusClass(reservation.payment_status)">
                                    {{ paymentStatusLabel(reservation.payment_status) }}
                                </span>
                            </div>
                        </span>
                    </span>
                    </div>

                    <div *ngIf="col.field === 'passenger_names'" [style.width.px]="col.width * 0.80"
                        style="white-space: normal; word-break: normal; overflow-wrap: break-word;">
                        <ng-container *ngIf="getPassengerNameSlots(reservation).length; else noPassengers">
                            <div *ngFor="let name of getPassengerNameSlots(reservation); let idx = index">
                                {{ idx + 1 }}.{{ name }}
                            </div>
                        </ng-container>
                        <div *ngIf="hasMissingPassengerNames(reservation)"
                            style="margin-top: 8px; padding: 4px 8px; background: #fef3c7; color: #92400e; border: 1px solid #f59e0b; border-radius: 6px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px;">
                            <span aria-hidden="true">⚠</span>
                            Missing passenger names
                        </div>
                        <ng-template #noPassengers>-</ng-template>
                    </div>
                    
                    <div *ngIf="col.field === 'passenger_count'" [style.width.px]="col.width * 0.80"
                        style="white-space: normal; word-break: normal; overflow-wrap: break-word;">
                        {{reservation.passenger_count}}
                        <div *ngIf="reservation.passenger_count_child">
                            + {{reservation.passenger_count_child}}
                        </div>
                    </div>
                    <div *ngIf="col.field === 'car_type'" [style.width.px]="col.width * 0.80"
                        style="white-space: normal; word-break: normal; overflow-wrap: break-word;">
                        {{reservation.car_type}}
                    </div>


                    <div *ngIf="col.field === 'flight_number'" [style.width.px]="col.width * 0.80"
                        style="white-space: normal; word-break: normal; overflow-wrap: break-word;">
                        {{reservation.flight_number}}
                        <span *ngIf="reservation.flight_date">
                            ({{reservation.flight_date | date:'yyyy-MM-dd'}})
                        </span>
                        <span *ngIf="reservation.flight_time">
                            {{reservation.flight_time}}
                        </span>
                    </div>

                    @if (col.field === 'passenger_name') {
                    {{reservation.passenger_name}}
                    <br><br>

                    <fa-icon [icon]="faPhone" size="lg"></fa-icon>
                    {{reservation.passenger_phone}}

                    <br><br>
                    @if (reservation.passenger_email){
                    <fa-icon [icon]="faEnvelope" size="lg"></fa-icon>
                    {{reservation.passenger_email}}
                    <br><br>
                    }

                    <fa-icon [icon]="faUsers" size="lg" style="margin-right: 5px;"></fa-icon>
                    {{reservation.passenger_count}}


                    <span *ngIf="reservation.passenger_count_child" [style.width.px]="col.width * 0.8"
                        style="white-space: normal; word-break: normal; overflow-wrap: break-word;">
                        + {{reservation.passenger_count_child}}
                    </span>

                    @if (reservation.child_seat_count > 0) {
                    <br><br>
                    Çocuk Koltuğu: {{reservation.child_seat_count}}
                    }

                    }

                    @if (col.field === 'note') {
                    {{ reservation.note }}
                    }

                </div>

            </td>

            <td class="action-column">
                <app-action-buttons [obj]="reservation" [editRole]="'company_rezervasyoncu'"
                    [deleteRole]="'company_rezervasyoncu'" [wantEdit]="reservation.status !== 'confirmed'"
                    [wantDelete]="reservation.status !== 'confirmed'" [wantDownloadPdf]="false" [wantDetail]="true"
                    [wantChangeRequest]="reservation.has_change_request || !!reservation.latest_change_request_status"
                    (detailEmitter)="detailObj(reservation)" (updateEmitter)="updateObj($event)"
                    (deleteEmitter)="deleteObj($event)" (downloadPdfEmitter)="downloadPdf($event)"
                    (changeRequestEmitter)="openChangeRequests(reservation)">
                </app-action-buttons>
            </td>
        </tr>
    </ng-template>
</p-table>

<app-shared-paginator [first]="first" [rows]="rows" [totalRecords]="totalRecords"
    (onPageChangeEmitter)="onPageChange($event)">
</app-shared-paginator>

<!-- Hidden PDF Component -->
@if (isGeneratingPdf) {
<app-reservation-pdf #pdfContent [reservation]="reservationForPdf!">
</app-reservation-pdf>
}


<p-toast position="bottom-right" [life]="20000" />
<p-confirmDialog />
