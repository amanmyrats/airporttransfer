<section class="reservation-detail-page">
    <ng-template #reservationDetails let-extraClass="extraClass">
      <div class="reservation-details" [ngClass]="extraClass">
        <h2 *ngIf="extraClass !== 'reservation-details--inline'">
          {{ translations.reservationDetails[langInput.code] }}
        </h2>
        <figure class="car-image-wrapper">
          <img
            [src]="'images/cartypes/' + selectedCar?.image.name[languageService.currentLang().code]" 
            [alt]="selectedCar?.image.alt[languageService.currentLang().code]"
            class="car-image"
          />
          <figcaption class="car-image__caption" *ngIf="selectedCar">
            <span class="car-image__name">{{ selectedCar.name }}</span>
            <span class="car-image__equivalent">{{ translations.orEquivalent[langInput.code] }}</span>
          </figcaption>
        </figure>
        <div class="reservation-summary">
          <div class="reservation-summary__route" *ngIf="fromLocation || toLocation">
            <div class="summary-route" *ngIf="fromLocation as pickupFull">
              <div class="route-chip">
                <span class="route-icon" aria-hidden="true">üìç</span>
                <span class="route-text">
                  <span class="route-text__label">{{ translations.from[langInput.code] }}</span>
                  <ng-container *ngIf="getAddressLines(pickupFull) as pickupAddress">
                    <span class="route-text__primary">{{ pickupAddress.primary || pickupFull }}</span>
                    <span class="route-text__secondary" *ngIf="pickupAddress.secondary">{{ pickupAddress.secondary }}</span>
                  </ng-container>
                </span>
              </div>
            </div>

            <div class="summary-route summary-route--destination" *ngIf="toLocation as destinationFull">
              <div class="route-chip route-chip--destination">
                <span class="route-icon" aria-hidden="true">üèÅ</span>
                <span class="route-text">
                  <span class="route-text__label route-text__label--destination">{{ translations.to[langInput.code] }}</span>
                  <ng-container *ngIf="getAddressLines(destinationFull) as destinationAddress">
                    <span class="route-text__primary">{{ destinationAddress.primary || destinationFull }}</span>
                    <span class="route-text__secondary" *ngIf="destinationAddress.secondary">{{ destinationAddress.secondary }}</span>
                  </ng-container>
                </span>
              </div>
            </div>
          </div>

          <div class="reservation-summary__metrics" *ngIf="distance > 0 || duration > 0">
            <div class="metric" *ngIf="distance > 0">
              <span class="metric-icon" aria-hidden="true">üõ£Ô∏è</span>
              <strong class="metric-value">{{ distance | number: '1.0-0' }} km</strong>
            </div>
            <div class="metric" *ngIf="duration > 0">
              <span class="metric-icon" aria-hidden="true">‚è±Ô∏è</span>
              <strong class="metric-value">{{ duration | durationFormat: langInput?.code }}</strong>
            </div>
          </div>
          <div class="reservation-map" *ngIf="shouldRenderRouteMap()">
            <img
              class="reservation-map__image"
              [src]="routeStaticMapUrl!"
              alt="Route preview map"
            />
            <div class="reservation-map__distance" *ngIf="distance > 0">
              <span>{{ distance | number: '1.0-0' }} km</span>
            </div>
          </div>
        </div>
      </div>
    </ng-template>
    <div class="container">
      <!-- Left Section: Reservation Details -->
      <ng-container *ngIf="shouldShowAsideSummary()">
        <ng-container *ngTemplateOutlet="reservationDetails; context: { extraClass: null }"></ng-container>
      </ng-container>

      <!-- Right Section: Form -->
      <div class="reservation-form">
        <h2>
          {{ translations.completeYourReservation[langInput.code] }}
        </h2>
        <form [formGroup]="bookingService.bookingCompletionForm" (ngSubmit)="onSubmit()">
          <!-- Travel and Flight Info -->
            <div class="form-group">
            <h3>
          {{ translations.travelAndFlightInfo[langInput.code] }}
            </h3>
            <div class="form-item" *ngIf="showCustomPickupFullInput">
              <label for="popular_route_location">
                {{ translations.customPickupLabel[langInput.code] }}
              </label>
              <input
                type="text"
                id="popular_route_location" 
                formControlName="pickup_full"
              />
            </div>

            <div class="form-item" *ngIf="showCustomDestinationFullInput">
              <label for="popular_route_location">
                {{ translations.customDestinationLabel[langInput.code] }}
              </label>
              <input
                type="text"
                id="popular_route_location" 
                formControlName="dest_full"
              />
            </div>
            <div class="form-row">
              <div class="form-item">
                <label for="transfer_date">          
                  {{ translations.transferDate[langInput.code] }}
                </label>
                <input type="date" id="transfer_date" formControlName="transfer_date" />
                <div
                  *ngIf="hasSubmitted && bookingService.bookingCompletionForm.get('transfer_date')?.invalid"
                  class="form-alert form-alert--error form-alert--compact"
                >
                  {{ translations.fieldRequired[langInput.code] }}
                </div>
              </div>
              
              <div class="form-item">
                <label for="transfer_time">
                {{ translations.transferTime[langInput.code] }} 
                  <span
                    class="time-selected"
                    [class.time-selected--animate]="animateTransferTime"
                    *ngIf="bookingService.bookingCompletionForm.get('transfer_time')?.value"
                  >
                    [ {{ bookingService.bookingCompletionForm.get('transfer_time')?.value }} ]
                  </span>
                </label>
                <input
                  type="time"
                  id="transfer_time"
                  formControlName="transfer_time"
                  required 
                  [attr.lang]="timePickerLocale"
                  (change)="onTimeChange('transfer_time')"
                />
                <div
                  *ngIf="hasSubmitted && bookingService.bookingCompletionForm.get('transfer_time')?.invalid"
                  class="form-alert form-alert--error form-alert--compact"
                >
                  {{ translations.fieldRequired[langInput.code] }}
                </div>
              </div>

              <div class="form-item">
                <label for="flight_number">
                {{ translations.flightNumber[langInput.code] }}
                </label>
                <input type="text" id="flight_number" formControlName="flight_number" placeholder="e.g., TK1234" />
              </div>
            </div>

            <div class="toggle-switch-container">
              <span>
                {{ translations.returnTransfer[langInput.code] }}
              </span>
              <label class="toggle-switch">
                <input
                  type="checkbox"
                  formControlName="is_round_trip"
                  (change)="toggleReturnFields()"
                />
                <span class="toggle-switch__slider" aria-hidden="true"></span>
              </label>
            </div>

            <div *ngIf="bookingService.bookingCompletionForm.get('is_round_trip')?.value">
              <div class="form-row">
                <div class="form-item">
                  <label for="return_transfer_date">
                {{ translations.returnTransferDate[langInput.code] }}
                  </label>
                  <input type="date" id="return_transfer_date" formControlName="return_transfer_date" />
                </div>
                <div class="form-item">
                  <label for="return_transfer_time">
                {{ translations.returnTransferTime[langInput.code] }}
                    <span
                      class="time-selected"
                      [class.time-selected--animate]="animateReturnTime"
                      *ngIf="bookingService.bookingCompletionForm.get('return_transfer_time')?.value"
                    >
                      [ {{ bookingService.bookingCompletionForm.get('return_transfer_time')?.value }} ]
                    </span>
                  </label>

                  <input
                    type="time"
                    id="return_transfer_time"
                    formControlName="return_transfer_time"
                    [attr.lang]="timePickerLocale"
                    (change)="onTimeChange('return_transfer_time')"
                  />
                </div>


              <div class="form-item">
                <label for="return_flight_number">
                {{ translations.returnFlightNumber[langInput.code] }}
                </label>
                <input type="text" id="return_flight_number" formControlName="return_flight_number" placeholder="e.g., TK1234" />
              </div>

              </div>
            </div>
          </div>
  
          <!-- Personal Info -->
          <div class="form-group">
            <h3>
              {{ translations.personalInfo[langInput.code] }}
            </h3>
            <div class="form-row">
              <div class="form-item">
                <label for="passenger_name">
              {{ translations.fullName[langInput.code] }}
                </label>
                <input type="text" id="passenger_name" formControlName="passenger_name" placeholder="{{ translations.fullName[langInput.code] }}" required />
                <div
                  *ngIf="hasSubmitted && bookingService.bookingCompletionForm.get('passenger_name')?.invalid"
                  class="form-alert form-alert--error form-alert--compact"
                >
                  {{ translations.fieldRequired[langInput.code] }}
                </div>
              </div>
              <div class="form-item">
                <label for="passenger_email">
                  {{ translations.email[langInput.code] }}
                </label>
                <input type="email" id="passenger_email" formControlName="passenger_email" placeholder="{{ translations.email[langInput.code] }}" />

  <!-- Show warning only if user typed something and it's invalid -->
  <div
    *ngIf="hasSubmitted && bookingService.bookingCompletionForm.get('passenger_email')?.value && bookingService.bookingCompletionForm.get('passenger_email')?.invalid"
    class="form-alert form-alert--warn form-alert--compact"
  >
    {{ translations.invalidEmail[langInput.code] || 'Please enter a valid email address.' }}
  </div>
              </div>
              <div class="form-item">
                
                @defer {
                  <label for="passenger_phone" class="form-label-muted" style="margin-bottom: 4px; display: block;">
                  {{ translations.phone[langInput.code] }}
                </label>
                  <ngx-intl-tel-input
                    id="passenger_phone"
                    class="ngx-intl-tel-input"
                    [preferredCountries]="preferredCountries"
                    [enableAutoCountrySelect]="false"
                    [enablePlaceholder]="true"
                    [searchCountryFlag]="true"
                    [searchCountryField]="searchFields"
                    [selectFirstCountry]="false"
                    [selectedCountryISO]="defaultCountry"
                    [phoneValidation]="false"
                    [separateDialCode]="true"
                    formControlName="passenger_phone"
                  ></ngx-intl-tel-input>
                }
                

                <!-- <label for="passenger_phone">
                  {{ translations.phone[langInput.code] }}
                </label>
                <input type="tel" id="passenger_phone" 
                  formControlName="passenger_phone" placeholder="{{ translations.primaryPhone[langInput.code] }}" required /> -->
              <!-- Format hint -->
              <!-- <small class="form-hint">
                {{ translations.phoneFormatHint?.[langInput.code] || 'Please include country code, starting with + or 00 (e.g. +90 555 555 5555)' }}
              </small> -->

                <div
                  *ngIf="hasSubmitted && bookingService.bookingCompletionForm.get('passenger_phone')?.invalid"
                  class="form-alert form-alert--error form-alert--compact"
                >
                  {{ translations.fieldRequired[langInput.code] }}
                </div>
              </div>
              <!-- <div class="form-item">
                <label for="passenger_additional_phone">
                {{ translations.additionalPhone[langInput.code] }}
                </label>
                <input type="tel" id="passenger_additional_phone" 
                formControlName="passenger_additional_phone" placeholder="{{ translations.additionalPhone[langInput.code] }}" />
              </div> -->
              <div class="form-item">
                <label for="passenger_count">
                  {{ translations.passengerCount[langInput.code] }}
                  :
                </label>
                <div class="number-spinner">
                  <button
                    type="button"
                    class="number-spinner__btn"
                    (click)="adjustNumber('passenger_count', -1, 0, 20)"
                    [disabled]="(bookingService.bookingCompletionForm.get('passenger_count')?.value || 0) <= 0"
                    aria-label="Decrease passenger count"
                  >
                    &minus;
                  </button>
                  <input
                    type="number"
                    id="passenger_count"
                    formControlName="passenger_count"
                    min="0"
                    max="20"
                    (change)="onNumberInputEvent('passenger_count', $event, 0, 20)"
                  />
                  <button
                    type="button"
                    class="number-spinner__btn"
                    (click)="adjustNumber('passenger_count', 1, 0, 20)"
                    [disabled]="(bookingService.bookingCompletionForm.get('passenger_count')?.value || 0) >= 20"
                    aria-label="Increase passenger count"
                  >
                    +
                  </button>
                </div>
              </div>
              <div class="form-item">
                <label for="passenger_count_child">
                  {{ translations.childCount[langInput.code] }}
                   (1-7 
                  {{ translations.yearsOld[langInput.code] }}
                  ):
                </label>
                <div class="number-spinner">
                  <button
                    type="button"
                    class="number-spinner__btn"
                    (click)="adjustNumber('passenger_count_child', -1, 0, 9)"
                    [disabled]="(bookingService.bookingCompletionForm.get('passenger_count_child')?.value || 0) <= 0"
                    aria-label="Decrease child passenger count"
                  >
                    &minus;
                  </button>
                  <input
                    type="number"
                    id="passenger_count_child"
                    formControlName="passenger_count_child"
                    min="0"
                    max="9"
                    (change)="onNumberInputEvent('passenger_count_child', $event, 0, 9)"
                  />
                  <button
                    type="button"
                    class="number-spinner__btn"
                    (click)="adjustNumber('passenger_count_child', 1, 0, 9)"
                    [disabled]="(bookingService.bookingCompletionForm.get('passenger_count_child')?.value || 0) >= 9"
                    aria-label="Increase child passenger count"
                  >
                    +
                  </button>
                </div>
              </div>
            </div>
          </div>
  

          <!-- Extra Services -->
          <div class="form-group">
            <h3>
              {{ translations.extraServices[langInput.code] }}
            </h3>

            <div class="toggle-switch-container">
              <span>
                {{ translations.needChildSeat[langInput.code] }}
              </span>
            <div>
              {{ translations.childSeatPricePerUnit[langInput.code] }}
            </div>

              <label class="toggle-switch">
                <input
                  type="checkbox"
                  formControlName="need_child_seat"
                  (change)="onChildSeatToggle($event)"
                />
                <span class="toggle-switch__slider" aria-hidden="true"></span>
              </label>
              <div
                class="number-spinner number-spinner--inline"
                *ngIf="bookingService.bookingCompletionForm.value.need_child_seat"
              >
                <button
                  type="button"
                  class="number-spinner__btn"
                  (click)="adjustNumber('child_seat_count', -1, 1, 9)"
                  [disabled]="(bookingService.bookingCompletionForm.get('child_seat_count')?.value || 0) <= 1"
                  aria-label="Decrease child seat count"
                >
                  &minus;
                </button>
                <input
                  type="number"
                  id="child_seat_count"
                  formControlName="child_seat_count"
                  min="1"
                  max="9"
                  (change)="onNumberInputEvent('child_seat_count', $event, 1, 9)"
                />
                <button
                  type="button"
                  class="number-spinner__btn"
                  (click)="adjustNumber('child_seat_count', 1, 1, 9)"
                  [disabled]="(bookingService.bookingCompletionForm.get('child_seat_count')?.value || 0) >= 9"
                  aria-label="Increase child seat count"
                >
                  +
                </button>
              </div>
            </div>
            
          <!-- Greeting with Flower -->
          <div class="toggle-switch-container">
            <span>
              {{ translations.greetingWithFlower[langInput.code] }}
            </span> 
            <div>+15 ‚Ç¨</div>

            <label class="toggle-switch">
              <input
                type="checkbox"
                formControlName="greet_with_flower"
                (change)="calculateFlowerPrice()"
              />
              <span class="toggle-switch__slider" aria-hidden="true"></span>
            </label>
          </div>

          <!-- Greeting with Champagne -->
          <div class="toggle-switch-container">
            <span>
              {{ translations.greetingWithChampagne[langInput.code] }}
            </span>
            <div>+25 ‚Ç¨</div>
            <label class="toggle-switch">
              <input
                type="checkbox"
                formControlName="greet_with_champagne"
                (change)="calculateChampagnePrice()"
              />
              <span class="toggle-switch__slider" aria-hidden="true"></span>
            </label>
          </div>

            <div class="form-item">
              <label for="note">
                {{ translations.note[langInput.code] }}
              </label>
              <textarea id="note" formControlName="note" rows="3" 
                placeholder="{{ translations.notePlaceholder[langInput.code] }}"></textarea>
            </div>
          </div>

          <ng-container *ngIf="shouldShowInlineSummary()">
            <ng-container *ngTemplateOutlet="reservationDetails; context: { extraClass: 'reservation-details--inline' }"></ng-container>
          </ng-container>


          <!-- Payment Information -->
<div class="form-group">
  <h3>
    {{ translations.payment[langInput.code] }}
  </h3>
  <div class="payment-info">
    <!-- Single Trip -->
    <ng-container *ngIf="!bookingService.bookingCompletionForm.get('is_round_trip')?.value; else roundTrip">
      <div class="price-breakdown">
        <div class="price-row">
          <span class="price-label">
            {{ translations.basePrice[langInput.code] }}
            :
          </span>
          <span class="price-value">{{ price! }} {{ currency?.sign }}</span>
        </div>
        <div class="price-row" *ngIf="childSeatPrice() > 0">
          <span class="price-label">
            {{ translations.firstTripChildSeatPrice[langInput.code] }}:</span>
          <span class="price-value">{{ childSeatPrice() }} {{ currency?.sign }}</span>
        </div>
        <div class="price-row" *ngIf="flowerPrice() > 0">
          <span class="price-label">
            {{ translations.flowerPrice[langInput.code] }}:</span>
          <span class="price-value">{{ flowerPrice() }} {{ currency?.sign }}</span>
        </div>
        <div class="price-row" *ngIf="champagnePrice() > 0">
          <span class="price-label">
            {{ translations.champagnePrice[langInput.code] }}:</span>
          <span class="price-value">{{ champagnePrice() }} {{ currency?.sign }}</span>
        </div>
      </div>
      <div class="total-price-container">
        <strong class="total-price">
          {{ translations.total[langInput.code] }}: 
          {{ price + childSeatPrice() + champagnePrice() + flowerPrice() }} {{ currency?.sign }}
        </strong>
      </div>
    </ng-container>

    <!-- Round Trip -->
    <ng-template #roundTrip>
      <div class="price-breakdown">
      <div class="price-row">
        <span class="price-label">
          {{ translations.firstTripBasePrice[langInput.code] }}:</span>
        <span class="price-value">{{ price! }} {{ currency?.sign }}</span>
      </div>
      <div class="price-row" *ngIf="childSeatPrice() > 0">
        <span class="price-label">
          {{ translations.firstTripChildSeatPrice[langInput.code] }}:</span>
        <span class="price-value">{{ childSeatPrice() }} {{ currency?.sign }}</span>
      </div>
      <div class="price-row" *ngIf="flowerPrice() > 0">
        <span class="price-label">
          {{ translations.flowerPrice[langInput.code] }}:</span>
        <span class="price-value">{{ flowerPrice() }} {{ currency?.sign }}</span>
      </div>
      <div class="price-row" *ngIf="champagnePrice() > 0">
        <span class="price-label">
          {{ translations.champagnePrice[langInput.code] }}:</span>
        <span class="price-value">{{ champagnePrice() }} {{ currency?.sign }}</span>
      </div>
      <div class="price-row">
        <span class="price-label">
          {{ translations.secondTripBasePrice[langInput.code] }}:</span>
        <span class="price-value">{{ price! }} {{ currency?.sign }}</span>
      </div>
      <div class="price-row" *ngIf="childSeatPrice() > 0">
        <span class="price-label">
          {{ translations.secondTripChildSeatPrice[langInput.code] }}:</span>
        <span class="price-value">{{ childSeatPrice() }} {{ currency?.sign }}</span>
      </div>
    </div>
    
      <div class="total-price-container">
        <strong class="total-price">
          {{ translations.total[langInput.code] }}: 
          {{ price * 2 + childSeatPrice() * 2 + flowerPrice() + champagnePrice() }} {{ currency?.sign }}
        </strong>
      </div>
    </ng-template>

    <p class="note">
      <strong>

        {{ translations.paymentNote[langInput.code] }}
      </strong>
    </p>
  </div>
</div>

          <!-- Complete Reservation -->
          <div class="form-actions">
            <div
              *ngIf="hasSubmitted && bookingService.bookingCompletionForm.invalid"
              class="form-alert form-alert--info"
            >
              {{ translations.formError[langInput.code] }}
            </div>
            <button
              type="submit"
              class="btn-complete"
              [disabled]="isSaving"
              [class.btn-complete--loading]="isSaving"
              [attr.aria-busy]="isSaving"
            >
            {{ translations.completeReservation[langInput.code] }}
            </button>
            <button [hidden]="stepFromUrl == 3" type="button" class="btn-back" 
              (click)="goToPreviousStep()">
              {{ translations.back[langInput.code] }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </section>
  
